<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Master OTP</title>
	<link rel="apple-touch-icon" href="pages/ico/60.png" />
	<link rel="apple-touch-icon" sizes="76x76" href="pages/ico/76.png" />
	<link rel="apple-touch-icon" sizes="120x120" href="pages/ico/120.png" />
	<link rel="apple-touch-icon" sizes="152x152" href="pages/ico/152.png" />
	<link rel="icon" type="image/x-icon" href="favicon.ico" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-touch-fullscreen" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="default" />
	<meta content="Meet pages - The simplest and fastest way to build web UI for your dashboard or app." name="description" />
	<meta content="Ace" name="author" />
	<link href="assets/plugins/pace/pace-theme-flash.css" rel="stylesheet" type="text/css" />
	<link href="assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
	<link href="assets/plugins/jquery-scrollbar/jquery.scrollbar.css" rel="stylesheet" type="text/css" media="screen" />
	<link href="assets/plugins/select2/css/select2.min.css" rel="stylesheet" type="text/css" media="screen" />
	<link class="main-stylesheet" href="assets/css/style.css" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="/styles/style.css" />
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" />
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="/styles/countrySelector.css" />
	<link rel="preconnect" href="https://fonts.googleapis.com" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
	<script src="https://kit.fontawesome.com/44e4e59292.js" crossorigin="anonymous"></script>
	
	<style>
		.loading-spinner {
			border: 3px solid rgba(0, 0, 0, 0.1);
			border-left-color: #fff;
			border-radius: 100%;
			width: 16px;
			height: 16px;
			animation: spin 1s linear infinite;
		}
		
		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}
			
			100% {
				transform: rotate(360deg);
			}
		}
		
		.otp-input {
			width: 48px;
			height: 48px;
			text-align: center;
			font-size: 18px;
			border: 1px solid #d1d5db;
			border-radius: 8px;
			outline: none;
		}
		
		.otp-input:focus {
			border-color: #000;
			box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.04);
		}
		
		/* Disabled resend look */
		.resend-disabled {
			opacity: 0.6;
			cursor: not-allowed;
		}
	</style>
</head>

<body>
	<%- include("../commonJS/loader") %>
	<div class="layout-container ">
		
		<%- include("common/leftSide") %>
		
		<div class="w-1/2 h-full flex-shrink flex flex-col items-center">
			<div class="flex items-center justify-start w-2/3 py-5">
				<span class="material-symbols-outlined cursor-pointer pr-2" onclick="history.back()">
					<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="18px" fill="black">
						<path d="M360-200 80-480l280-280 56 56-183 184h647v80H233l184 184-57 56Z" />
					</svg>
				</span>
				<span class="text-xl cursor-pointer" onclick="history.back()">Back</span>
			</div>
			
			<!-- Master OTP Card (matches 2FA design) -->
			<div class="w-2/3 flex flex-col items-center">
				<h2 class="text-3xl p-3">Verify Master OTP</h2>
				<p class="text-gray-400 pb-5">Enter the 6-digit Master OTP</p>
				
				<form id="masterOtpForm" class="w-full">
					<div class="mb-3">
						<label class="form-label text-gray-500">Enter OTP</label>
						<div class="d-flex gap-2 justify-content-start">
							<!-- Six inputs -->
							<input type="text" id="otp1" maxlength="1" class="form-control otp-input" inputmode="numeric" pattern="[0-9]*" />
							<input type="text" id="otp2" maxlength="1" class="form-control otp-input" inputmode="numeric" pattern="[0-9]*" />
							<input type="text" id="otp3" maxlength="1" class="form-control otp-input" inputmode="numeric" pattern="[0-9]*" />
							<input type="text" id="otp4" maxlength="1" class="form-control otp-input" inputmode="numeric" pattern="[0-9]*" />
							<input type="text" id="otp5" maxlength="1" class="form-control otp-input" inputmode="numeric" pattern="[0-9]*" />
							<input type="text" id="otp6" maxlength="1" class="form-control otp-input" inputmode="numeric" pattern="[0-9]*" />
						</div>
					</div>
					
					<!-- Resend (disabled look, since master OTP is fixed) -->
					<!-- <div class="mb-5 flex justify-end text-sm w-full">
						<div class="w-fit">
							Didn't get OTP?
							<button id="resendOtp" type="button" class="resend-disabled text-danger focus:outline-none" disabled>Resend (N/A)</button>
						</div>
					</div> -->
					
					<div class="mb-3 w-full">
						<button type="submit" id="verifyOtpBtn" class="bg-black w-full text-white rounded-[.6rem] p-2 flex justify-center items-center gap-2">
							<span id="verifyText">Verify OTP</span>
							<div class="loading-spinner hidden" id="verifySpinner" role="status"></div>
						</button>
					</div>
				</form>
			</div>
			
		</div>
	</div>
	
	<!-- Scripts -->
	<script>
		// Utility: show toast (assumes /toast.js provides toast)
		// If your toast function differs, keep your existing include / usage.
		document.addEventListener("DOMContentLoaded", () => {
			const inputs = [
				document.getElementById("otp1"),
				document.getElementById("otp2"),
				document.getElementById("otp3"),
				document.getElementById("otp4"),
				document.getElementById("otp5"),
				document.getElementById("otp6"),
			];
			
			// focus first input
			inputs[0].focus();
			
			// Auto-move & backspace handling
			inputs.forEach((input, idx) => {
				input.addEventListener("input", (e) => {
					input.value = input.value.replace(/\D/g, ""); // only digits
					if (input.value.length === 1 && idx < inputs.length - 1) {
						inputs[idx + 1].focus();
					}
				});
				input.addEventListener("keydown", (e) => {
					if (e.key === "Backspace" && !input.value && idx > 0) {
						inputs[idx - 1].focus();
					}
				});
				// Optionally allow paste of full OTP
				input.addEventListener("paste", (e) => {
					e.preventDefault();
					const paste = (e.clipboardData || window.clipboardData).getData("text");
					const digits = paste.replace(/\D/g, "").slice(0, 6);
					for (let i = 0; i < digits.length; i++) {
						if (inputs[i]) inputs[i].value = digits[i];
					}
					if (digits.length === 6) inputs[5].focus();
				});
			});
			
			const form = document.getElementById("masterOtpForm");
			const verifyBtn = document.getElementById("verifyOtpBtn");
			const spinner = document.getElementById("verifySpinner");
			const verifyText = document.getElementById("verifyText");
			
			form.addEventListener("submit", async (e) => {
				e.preventDefault();
				
				let otp = inputs.map(i => i.value.trim()).join("");
				if (otp.length !== 6) {
					if (typeof toast === "function") toast("error", "Please enter 6-digit OTP");
					else alert("Please enter 6-digit OTP");
					return;
				}
				
				verifyBtn.disabled = true;
				verifyText.textContent = "";
				spinner.classList.remove("hidden");
				
				try {
					const res = await fetch("/api/users/verify-master-otp", {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
						credentials: "include", // important to include session cookie
						body: JSON.stringify({
							otp
						}),
					});
					
					const data = await res.json();
					
					verifyBtn.disabled = false;
					verifyText.textContent = "Verify OTP";
					spinner.classList.add("hidden");
					
					if (data.success) {
						if (typeof toast === "function") toast("success", data.message || "Master OTP verified");
						// redirect to dashboard (matches your other pages)
						setTimeout(() => {
							window.location.href = data.redirect || "/";
						}, 600);
					} else {
						if (typeof toast === "function") toast("error", data.message || "Invalid Master OTP");
					}
				} catch (err) {
					console.error(err);
					verifyBtn.disabled = false;
					verifyText.textContent = "Verify OTP";
					spinner.classList.add("hidden");
					if (typeof toast === "function") toast("error", "Server error verifying OTP");
				}
			});
		});
	</script>
	
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
	<script src="/toast.js"></script>
</body>

</html>
