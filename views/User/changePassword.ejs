<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reset Password</title>
  <link rel="apple-touch-icon" href="pages/ico/60.png" />
  <link rel="apple-touch-icon" sizes="76x76" href="pages/ico/76.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="pages/ico/120.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="pages/ico/152.png" />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-touch-fullscreen" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta content="Reset your password" name="description" />
  <meta content="Ace" name="author" />
  <link href="assets/plugins/pace/pace-theme-flash.css" rel="stylesheet" type="text/css" />
  <link href="assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="assets/plugins/jquery-scrollbar/jquery.scrollbar.css" rel="stylesheet" type="text/css" media="screen" />
  <link href="assets/plugins/select2/css/select2.min.css" rel="stylesheet" type="text/css" media="screen" />
  <!-- <link class="main-stylesheet" href="pages/css/themes/corporate.css" rel="stylesheet" type="text/css" /> -->
  <!-- Please remove the file below for production: Contains demo classes -->
  <link class="main-stylesheet" href="assets/css/style.css" rel="stylesheet" type="text/css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet"> <!-- Tailwind CSS and Bootstrap for styles -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles/style.css" />
  <style>
    .loading-spinner {
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-left-color: #fff;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .reset-button {
      background-color: #000;
      color: #fff;
      border: none;
      width: 100%;
      padding: 10px;
    }

    .reset-button:hover {
      background-color: #333;
    }

    .disabled {
      color: #f8d7da;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
	<%- include("../commonJS/loader") %>
  <div class="flex w-100 h-100">
    <!-- Left Section -->
    <div class="flex-grow left-section">
      <div class="mb-5">
        <img src="/assets/img/Wizard_logo.png" alt="Whizard Logo" style="max-width: 150px" class="w-25" />
      </div>
      <h1 class="gradient-text">Smart WhatsApp Solutions for Effortless Business</h1>
      <p class="p-text">
        Whizard helps businesses enhance WhatsApp communication by
        simplifying template creation, reporting, and integration seamlessly
        with other platforms.
      </p>
      <div class="img-preview">
      	<div class="carousel">
      		<img src="/assets/img/template.png" class="w-75 active" alt="Template Preview">
      		<img src="/assets/img/template2.jpg" class="w-75" alt="Template Preview" />
      		<img src="/assets/img/template3.jpg" class="w-75" alt="Template Preview" />
      		<img src="/assets/img/template4.jpg" class="w-75" alt="Template Preview" />
      		<img src="/assets/img/template5.jpg" class="w-75" alt="Template Preview" />
      		<img src="/assets/img/template6.jpg" class="w-75" alt="Template Preview" />
      	</div>
      	<div class="carousel-dots"></div>
      </div>
    </div>

    <!-- Right Section -->
    <div class="h-full p-5 right-section flex-shrink">
      <div class="flex flex-col ">

        <div class="mb-20 flex cursor-pointer" onclick="history.back()">
          <span class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="black">
              <path d="M360-200 80-480l280-280 56 56-183 184h647v80H233l184 184-57 56Z" />
            </svg>
          </span>
          <span class="text-lg ml-2">Back</span>
        </div>

        <h2 class="text-4xl font-semibold mb-4 text-center">Reset password</h2>
        <p class="text-gray-500 mb-10 text-lg text-center">
          Enter new password to reset your password
        </p>

        <!-- Email Input Field -->
        <div class="mb-4">
          <label for="password" class="form-label text-gray-700">Enter new Password</label>
          <div class="form-control flex items-center justify-between">
            <input type="password" id="password" name="password" placeholder="Enter password" class=" w-full" required />
            <!-- Visible eye icon -->
            <span id="visiblePassword" style="cursor: pointer; width: fit-content;">
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="18px" fill="#374151">
                <path d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Zm0-300Zm0 220q113 0 207.5-59.5T832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280Z" />
              </svg>
            </span>
            <!-- Not visible (slashed eye) icon -->
            <span id="notVisiblePassword" style="cursor: pointer; display:none; width: fit-content;">
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="18px" fill="#374151">
                <path d="m644-428-58-58q9-47-27-88t-93-32l-58-58q17-8 34.5-12t37.5-4q75 0 127.5 52.5T660-500q0 20-4 37.5T644-428Zm128 126-58-56q38-29 67.5-63.5T832-500q-50-101-143.5-160.5T480-720q-29 0-57 4t-55 12l-62-62q41-17 84-25.5t90-8.5q151 0 269 83.5T920-500q-23 59-60.5 109.5T772-302Zm20 246L624-222q-35 11-70.5 16.5T480-200q-151 0-269-83.5T40-500q21-53 53-98.5t73-81.5L56-792l56-56 736 736-56 56ZM222-624q-29 26-53 57t-53 67q50 101 143.5 160.5T480-280q20 0 39-2.5t39-5.5l-36-38q-11 3-21 4.5t-21 1.5q-75 0-127.5-52.5T300-500q0-11 1.5-21t4.5-21l-84-82Zm319 93Zm-151 75Z" />
              </svg>
            </span>
          </div>
          <small id="passwordError" class="text-danger pt-2" style="display: none;"></small>
        </div>

        <div class="mb-4">
          <label for="confirmPassword" class="form-label text-gray-700">Re-Enter new Password</label>
          <div class="form-control flex items-center justify-between">
            <input type="password" id="confirmPassword" name="confirmPassword" class=" w-full" placeholder="Confirm your password" required />
            <!-- Visible eye icon -->
            <span id="visibleConfirmPassword" style="cursor: pointer; width: fit-content;">
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="18px" fill="#374151">
                <path d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Zm0-300Zm0 220q113 0 207.5-59.5T832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280Z" />
              </svg>
            </span>
            <!-- Not visible (slashed eye) icon -->
            <span id="notVisibleConfirmPassword" style="cursor: pointer; display:none; width: fit-content;">
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="18px" fill="#374151">
                <path d="m644-428-58-58q9-47-27-88t-93-32l-58-58q17-8 34.5-12t37.5-4q75 0 127.5 52.5T660-500q0 20-4 37.5T644-428Zm128 126-58-56q38-29 67.5-63.5T832-500q-50-101-143.5-160.5T480-720q-29 0-57 4t-55 12l-62-62q41-17 84-25.5t90-8.5q151 0 269 83.5T920-500q-23 59-60.5 109.5T772-302Zm20 246L624-222q-35 11-70.5 16.5T480-200q-151 0-269-83.5T40-500q21-53 53-98.5t73-81.5L56-792l56-56 736 736-56 56ZM222-624q-29 26-53 57t-53 67q50 101 143.5 160.5T480-280q20 0 39-2.5t39-5.5l-36-38q-11 3-21 4.5t-21 1.5q-75 0-127.5-52.5T300-500q0-11 1.5-21t4.5-21l-84-82Zm319 93Zm-151 75Z" />
              </svg>
            </span>
          </div>
          <small id="confirmPasswordError" class="text-danger pt-2" style="display: none;"></small>
        </div>

        <!-- Submit Button -->
        <button id="resetButton" class="reset-button flex justify-center items-center">Reset</button>

        <!-- Success or Error Message -->
        <div id="message" class="text-center mt-3"></div>

      </div>
    </div>
  </div>

  </div>
  <!-- Include jQuery, Bootstrap JS, and any required scripts -->
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script src="carousel.js"></script>
  <script>
    function togglePasswordVisibility(inputId, visibleIconId, notVisibleIconId) {
      const inputElement = document.getElementById(inputId);
      const visibleIcon = document.getElementById(visibleIconId);
      const notVisibleIcon = document.getElementById(notVisibleIconId);

      // Toggle the type of the input field between 'password' and 'text'
      if (inputElement.type === 'password') {
        inputElement.type = 'text'; // Show the password
        visibleIcon.style.display = 'none'; // Hide the 'visible' icon
        notVisibleIcon.style.display = 'block'; // Show the 'not visible' icon
      } else {
        inputElement.type = 'password'; // Hide the password
        visibleIcon.style.display = 'block'; // Show the 'visible' icon
        notVisibleIcon.style.display = 'none'; // Hide the 'not visible' icon
      }
    }

    // Event listener for the 'visiblePassword' eye icon
    document.getElementById('visiblePassword').addEventListener('click', function() {
      togglePasswordVisibility('password', 'visiblePassword', 'notVisiblePassword');
    });

    // Event listener for the 'notVisiblePassword' eye icon
    document.getElementById('notVisiblePassword').addEventListener('click', function() {
      togglePasswordVisibility('password', 'visiblePassword', 'notVisiblePassword');
    });

    // Event listener for the 'visibleConfirmPassword' eye icon
    document.getElementById('visibleConfirmPassword').addEventListener('click', function() {
      togglePasswordVisibility('confirmPassword', 'visibleConfirmPassword', 'notVisibleConfirmPassword');
    });

    // Event listener for the 'notVisibleConfirmPassword' eye icon
    document.getElementById('notVisibleConfirmPassword').addEventListener('click', function() {
      togglePasswordVisibility('confirmPassword', 'visibleConfirmPassword', 'notVisibleConfirmPassword');
    });
    document.getElementById('resetButton').addEventListener('click', async function() {
      const password = document.getElementById('password').value.trim();
      const confirmPassword = document.getElementById('confirmPassword').value.trim();
      const passwordError = document.getElementById('passwordError');
      const confirmPasswordError = document.getElementById('confirmPasswordError');
      const messageDiv = document.getElementById('message');

      const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;

      // Clear any previous messages or errors
      passwordError.style.display = "none";
      confirmPasswordError.style.display = "none";
      messageDiv.textContent = '';

      // Validate password
      if (!passwordRegex.test(password)) {
        passwordError.style.display = "block";
        passwordError.textContent = "Password must be at least 8 characters long, include 1 lowercase, 1 uppercase letter, 1 number, and 1 special character.";
        return;
      }

      // Validate confirm password
      if (password !== confirmPassword) {
        confirmPasswordError.style.display = "block";
        confirmPasswordError.textContent = "Passwords do not match.";
        return;
      }

      // Retrieve email from URL params
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const email = urlParams.get('email');

      if (!email) {
        messageDiv.textContent = 'Error: Email not found in URL.';
        return;
      }

      // Disable the button and show spinner
      document.getElementById('resetButton').disabled = true;
      document.getElementById('resetButton').innerHTML = `<div class="loading-spinner"></div>`;

      try {
        const response = await fetch('/api/users/changePassword', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email,
            password
          })
        });

        const result = await response.json();

        if (response.ok) {
          messageDiv.textContent = 'Password reset successful. You can now log in.';
          messageDiv.classList.add('text-success');
          setTimeout(() => {
            window.location.href = "/login";
          }, 1500);
        } else {
          throw new Error(result.message || 'Error resetting password.');
        }
      } catch (error) {
        messageDiv.textContent = error.message;
        messageDiv.classList.add('text-danger');
      } finally {
        // Re-enable button
        document.getElementById('resetButton').disabled = false;
        document.getElementById('resetButton').innerHTML = 'Reset Password';
      }
    });
  </script>
 
</body>

</html>